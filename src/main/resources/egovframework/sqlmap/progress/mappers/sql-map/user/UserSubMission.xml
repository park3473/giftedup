<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="egovframework.kaist.user.submission.service.impl.UserSubMissionMapper">
	<select id="getSubMissionAllList" parameterType="egovframework.kaist.user.submission.model.UserSubMissionVo" resultType="hashMap">
		SELECT s.* , a.title FROM TBL_SUBMISSION s JOIN TBL_AWARD a ON s.AWARD_IDX = a.IDX
		WHERE 1=1
		<if test="SEARCH_TEXT != ''">
		    <if test="SEARCH_TYPE != 'ALL'">
	    		 AND s.${SEARCH_TYPE} LIKE '%${SEARCH_TEXT}%'
	    	</if>
	    </if>
	    AND s.MEMBER_ID = #{member_id}
	   	ORDER BY s.CREATE_TM DESC
	    LIMIT ${LIMIT} OFFSET ${OFFSET}
	</select>
	
	<select id="getSubMissionAllListCnt" parameterType="egovframework.kaist.user.submission.model.UserSubMissionVo" resultType="int">
		SELECT COUNT(*) FROM TBL_SUBMISSION
		WHERE 1=1
		<if test="SEARCH_TEXT != ''">
		    <if test="SEARCH_TYPE != 'ALL'">
	    		 AND ${SEARCH_TYPE} LIKE '%${SEARCH_TEXT}%'
	    	</if>
	    </if>
	    AND MEMBER_ID = #{member_id} 
	</select>
	
	<insert id="setUserSubMissionDataInsert" parameterType="egovframework.kaist.user.submission.model.UserSubMissionVo">
		INSERT INTO TBL_SUBMISSION (AWARD_IDX , MEMBER_ID , NAME , CONTENT , STATUS , CREATE_TM , UPDATE_TM)
		VALUES (#{award_idx} , #{member_id} , #{name} , #{content} , '0' , now() , now())
	</insert>
	
	<insert id="setUserSubMissionDataAjaxInsert" parameterType="egovframework.kaist.user.submission.model.UserSubMissionVo" useGeneratedKeys="true" keyProperty="idx" >
		INSERT INTO TBL_SUBMISSION (AWARD_IDX , MEMBER_ID , NAME , CONTENT , STATUS , CREATE_TM , UPDATE_TM)
		VALUES (#{award_idx} , #{member_id} , #{name} , #{content} , '0' , now() , now())
	</insert>
	
	<select id="getSubMissionDataView" parameterType="egovframework.kaist.user.submission.model.UserSubMissionVo" resultType="egovframework.kaist.user.submission.model.UserSubMissionVo">
		SELECT * FROM TBL_SUBMISSION WHERE IDX = #{idx} AND AWARD_IDX = #{award_idx}
	</select>
	
	<update id="setUserSubMissionDataUpdate" parameterType="egovframework.kaist.user.submission.model.UserSubMissionVo">
		UPDATE TBL_SUBMISSION SET
		<if test="content != ''">
			CONTENT = #{content},
		</if>
		<if test="status != ''">
			STATUS = #{status},
		</if>
		UPDATE_TM = now()
		WHERE IDX = #{idx}
	</update>
	
	<delete id="setUserSubMissionDataDelete" parameterType="egovframework.kaist.user.submission.model.UserSubMissionVo">
		DELETE FROM TBL_SUBMISSION WHERE IDX = #{idx}
	</delete>
	
	<select id="getSubMissionDetailList" parameterType="egovframework.kaist.user.submission.model.UserSubMissionVo" resultType="hashMap">
		SELECT detail.* , requires.require_name , requires.require_content FROM TBL_SUBMISSION_DETAIL detail JOIN TBL_AWARD_REQUIRE requires ON detail.require_idx = requires.idx
		WHERE detail.SUBMISSION_IDX = #{idx}
		ORDER BY detail.CREATE_TM
	</select>
	
	<insert id="setUserSubMissionDetailInsert" parameterType="egovframework.kaist.user.submission.model.UserSubMissionDetailVo">
		INSERT INTO TBL_SUBMISSION_DETAIL (SUBMISSION_IDX , REQUIRE_IDX , RESPOND , CREATE_TM , UPDATE_TM)
		VALUES (#{submission_idx} , #{require_idx} , #{respond} , now() , now())
	</insert>
	
	<update id="setUserSubMissionDetailUpdate" parameterType="egovframework.kaist.user.submission.model.UserSubMissionDetailVo">
		UPDATE TBL_SUBMISSION_DETAIL SET
		<if test="respond != ''">
			RESPOND = #{respond},
		</if>
		UPDATE_TM = now()
		WHERE IDX = #{idx}
	</update>
	
	<delete id="setUserSubMissionDetailDelete" parameterType="egovframework.kaist.user.submission.model.UserSubMissionDetailVo">
		DELETE FROM TBL_SUBMISSION_DETAIL WHERE IDX = #{idx}
	</delete>
	
	<delete id="setUserSubMissionDetailDeleteAll" parameterType="egovframework.kaist.user.submission.model.UserSubMissionDetailVo">
		DELETE FROM TBL_SUBMISSION_DETAIL WHERE SUBMISSION_IDX = #{submission_idx}
	</delete>
	
	<select id="getSubMissionFileList" parameterType="egovframework.kaist.user.submission.model.UserSubMissionVo" resultType="hashMap">
		SELECT * FROM TBL_SUBMISSION_FILE
		WHERE SUBMISSION_IDX = #{idx} AND MEMBER_ID = #{member_id}
	</select>
	
	<insert id="setUserSubMissionFileInsert" parameterType="egovframework.kaist.user.submission.model.UserSubMissionFileVo">
		INSERT INTO TBL_SUBMISSION_FILE (SUBMISSION_IDX , MEMBER_ID , FILE , CREATE_TM , UPDATE_TM)
		VALUES (#{submission_idx} , #{member_id} , #{file} , now() , now())
	</insert>

	<delete id="setUserSubMissionFileDelete" parameterType="egovframework.kaist.user.submission.model.UserSubMissionFileVo">
		DELETE FROM TBL_SUBMISSION_FILE WHERE IDX = #{idx} AND SUBMISSION_IDX = #{submission_idx} AND MEMBER_ID = #{member_id}
	</delete>

</mapper>