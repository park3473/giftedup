<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="egovframework.kaist.admin.communicator.service.impl.AdminCommunicatorMapper">
	
	<select id="getCommAllList" resultType="hashMap" parameterType="egovframework.kaist.admin.communicator.model.AdminCommunicatorVo">
		SELECT * 
		FROM TBL_COMMUNICATOR
		WHERE 1 = 1
		<if test="SEARCH_TEXT != ''">
		     <if test="SEARCH_TYPE == 'ALL'">
		     	AND (
		     		COMM_NAME LIKE '%${SEARCH_TEXT}%'
		     		OR COMM_MENTO_NAME LIKE '%${SEARCH_TEXT}%'
		     		OR COMM_TYPE LIKE '%${SEARCH_TEXT}%'
		     	)
		     </if>
		     <if test="SEARCH_TYPE != 'ALL'">
		     	AND ${SEARCH_TYPE} LIKE '%${SEARCH_TEXT}%'
		     </if>
		</if>
		<if test="COMM_TYPE != ''">
			AND COMM_TYPE = '${COMM_TYPE}'
		</if>
		<if test="COMM_TIME != ''">
			AND COMM_TIME = '${COMM_TIME}'
		</if>
		<if test="COMM_STAT != ''">
			AND COMM_STAT = '${COMM_STAT}'
		</if>
		<if test="COMM_START_TM != ''">
			AND DATE_FORMAT(COMM_START_TM,'%Y.%m.%d') = '${COMM_START_TM}'
		</if>
		<if test="COMM_SUPPLIES != ''">
			AND COMM_SUPPLIES = #{COMM_SUPPLIES}
		</if>
		ORDER BY COMM_START_TM
		LIMIT ${LIMIT} OFFSET ${OFFSET}
	</select>
	<select id="getCommAllListCnt" resultType="int" parameterType="egovframework.kaist.admin.communicator.model.AdminCommunicatorVo">
		SELECT COUNT(*)
		FROM TBL_COMMUNICATOR
		WHERE 1 = 1
		<if test="SEARCH_TEXT != ''">
		     <if test="SEARCH_TYPE == 'ALL'">
		     	AND (
		     		COMM_NAME LIKE '%${SEARCH_TEXT}%'
		     		OR COMM_MENTO_NAME LIKE '%${SEARCH_TEXT}%'
		     		OR COMM_TYPE LIKE '%${SEARCH_TEXT}%'
		     	)
		     </if>
		     <if test="SEARCH_TYPE != 'ALL'">
		     	AND ${SEARCH_TYPE} LIKE '%${SEARCH_TEXT}%'
		     </if>
		</if>
		<if test="COMM_TYPE != ''">
			AND COMM_TYPE = '${COMM_TYPE}'
		</if>
		<if test="COMM_TIME != ''">
			AND COMM_TIME = '${COMM_TIME}'
		</if>
		<if test="COMM_STAT != ''">
			AND COMM_STAT = '${COMM_STAT}'
		</if>
		<if test="COMM_START_TM != ''">
			AND DATE_FORMAT(COMM_START_TM,'%Y.%m.%d') = '${COMM_START_TM}'
		</if>
		<if test="COMM_SUPPLIES != ''">
			AND COMM_SUPPLIES = #{COMM_SUPPLIES}
		</if>
	</select>
	<select id="getCommView" resultType="egovframework.kaist.admin.communicator.model.AdminCommunicatorVo" parameterType="egovframework.kaist.admin.communicator.model.AdminCommunicatorVo">
		SELECT * FROM TBL_COMMUNICATOR
		WHERE COMM_IDX = #{COMM_IDX}
	</select>
	
	<select id="getStudentList" resultType="hashMap" parameterType="egovframework.kaist.admin.communicator.model.AdminCommStudentVo">
		SELECT c.* , m.* , m2.NAME AS MENTO_NAME ,  m2.PHONE AS MENTO_PHONE
		FROM TBL_COMM_STUDENT c JOIN TBL_MEMBER m JOIN TBL_MEMBER m2 JOIN TBL_MATCHING matching 
		WHERE m.MEMBER_ID = c.STU_MEMBER_ID
		AND m.MEMBER_ID = matching.MEMBER_ID
		AND m2.MEMBER_ID = matching.PROFESSOR_MEMBER_ID 
		and c.COMM_IDX = #{COMM_IDX}
		AND matching.year = '2021'
	</select>
	
	<select id="getSuppliesList" resultType="egovframework.kaist.admin.communicator.model.AdminCommSuppliesVo" parameterType="egovframework.kaist.admin.communicator.model.AdminCommSuppliesVo">
		SELECT * FROM TBL_COMM_SUPPLIES
		WHERE COMM_IDX = #{COMM_IDX}
	</select>

	<select id="getCommExcelAll" resultType="hashMap" parameterType="egovframework.kaist.admin.communicator.model.AdminCommunicatorVo">
		SELECT COMM.* , M.PHONE FROM TBL_COMMUNICATOR COMM JOIN TBL_MEMBER M ON COMM.COMM_MENTO = M.MEMBER_ID
		WHERE 1 = 1
		<if test="COMM_TYPE != ''">
			AND COMM.COMM_TYPE = #{COMM_TYPE}
		</if>
		<if test="COMM_TIME != ''">
			AND COMM.COMM_TIME = '${COMM_TIME}'
		</if>
		<if test="COMM_STAT != ''">
			AND COMM.COMM_STAT = '${COMM_STAT}'
		</if>
		<if test="COMM_START_TM != ''">
			AND DATE_FORMAT(COMM_START_TM,'%Y.%m.%d') = '${COMM_START_TM}'
		</if>
		<if test="COMM_SUPPLIES != ''">
			AND COMM.COMM_SUPPLIES = #{COMM_SUPPLIES}
		</if>
		<if test="COMM_YEAR != ''">
			AND COMM.COMM_YEAR = #{COMM_YEAR}
		</if>
	</select>
	
	<select id="getCommExcelSelect" resultType="hashMap" parameterType="egovframework.kaist.admin.communicator.model.AdminCommunicatorVo">
		SELECT COMM.* , M.PHONE FROM TBL_COMMUNICATOR COMM JOIN TBL_MEMBER M ON COMM.COMM_MENTO = M.MEMBER_ID
		WHERE 1 = 1
		AND COMM.COMM_IDX = #{COMM_IDX}
		AND COMM.COMM_YEAR = #{COMM_YEAR}
	</select>
	
	<select id="getStudentExcelSelect" resultType="hashMap" parameterType="egovframework.kaist.admin.communicator.model.AdminCommunicatorVo">
		SELECT *
		FROM TBL_COMM_STUDENT
		WHERE 1 = 1
		AND COMM_IDX = #{COMM_IDX}
		AND COMM.COMM_YEAR = #{COMM_YEAR}
	</select>
	
</mapper>