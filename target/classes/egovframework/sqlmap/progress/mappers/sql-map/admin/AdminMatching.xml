<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="egovframework.kaist.admin.matching.service.impl.AdminMatchingMapper">
	 
	<select id="getListAll" resultType="hashMap" >
		SELECT /*AdminMatchingMapper*/ * FROM TBL_MATCHING order by CREATE_TM desc
	</select>

	
	<select id="getList" resultType="hashMap" parameterType="egovframework.kaist.admin.matching.model.AdminMatchingVo">
		SELECT 
			student.MEMBER_ID AS StudentID,
			student.ADDRESS_LOCAL AS Student_ADDRESS_LOCAL,
		   	student.NAME AS StudentName, 
		   	student.BIRTH AS StudentBIRTH,
			student.SEX AS StudentSEX,
			student.SCHOOL_NAME AS StudentSCHOOL_NAME,
			student.SCHOOL_YEAR AS StudentSCHOOL_YEAR,
			student.SUPPORT_AREA AS StudentSUPPORT_AREA,
			student.PHONE AS StudentPHONE,
			student.PARENTS_PHONE AS StudentPARENTS_PHONE,
			student.ELIGIBILITY AS StudentELIGIBILITY,
			student.ADDRESS AS StudentADDRESS,
			student.ADDRESS_DETAIL AS StudentADDRESS_DETAIL,
		   	teacher.MEMBER_ID AS TeacherID, 
		   	teacher.NAME AS TeacherName, 
		   	teacher.ADDRESS_LOCAL AS TeacherADDRESS_LOCAL,
		   	teacher.SCHOOL_NAME AS TeacherSCHOOL_NAME,
		   	teacher.SEX AS TeacherSEX,
		   	teacher.PHONE AS TeacherPHONE,
		   	teacher.EMAIL AS TeacherEMAIL
		FROM 
		    TBL_MATCHING AS matching 
		INNER JOIN 
		    TBL_MEMBER AS student ON matching.MEMBER_ID = student.MEMBER_ID 
		LEFT JOIN 
		    TBL_MEMBER AS teacher ON matching.PROFESSOR_MEMBER_ID = teacher.MEMBER_ID
		WHERE 1=1 
		AND matching.YEAR = #{YEAR}
		<if test="PROFESSOR_MEMBER_ID != ''">
	    	AND matching.PROFESSOR_MEMBER_ID = #{PROFESSOR_MEMBER_ID}
	    </if>
	   	<if test="SUPPORT_GROUP != ''">
	    	AND matching.SUPPORT_GROUP = #{SUPPORT_GROUP}
	    </if>
	    <if test="LO_TYPE == 'TRUE'">
	    	AND student.ADDRESS_LOCAL IN 
		    <foreach collection="LO_LIST" item="bno" open="(" close=")" separator=",">
		    	#{bno}
		    </foreach>
	    </if>
	     <if test="SEARCH_TEXT != ''">
		     <if test="SEARCH_TYPE == 'ALL'">
		    	AND (
		    		NAME LIKE '%${SEARCH_TEXT}%' 
		    		OR  matching.MEMBER_ID LIKE '%${SEARCH_TEXT}%'
		    		OR  matching.SCHOOL_NAME LIKE '%${SEARCH_TEXT}%'
		    		OR  matching.PROFESSOR_MEMBER_ID LIKE '%${SEARCH_TEXT}%'
		    		OR  matching.PROFESSOR_MEMBER_NAME LIKE '%${SEARCH_TEXT}%'
		    		
		    		
		    		) 
		    </if>
		    <if test="SEARCH_TYPE != 'ALL'">
	    		 AND matching.${SEARCH_TYPE} LIKE '%${SEARCH_TEXT}%'
	    	</if>
	    </if>
		ORDER BY student.NAME , matching.UPDATE_TM
	</select>
		
	<select id="getListCnt" resultType="int" parameterType="egovframework.kaist.admin.matching.model.AdminMatchingVo">
		SELECT
			COUNT(*)
		FROM 
		    TBL_MATCHING AS matching 
		INNER JOIN 
		    TBL_MEMBER AS student ON matching.MEMBER_ID = student.MEMBER_ID 
		LEFT JOIN 
		    TBL_MEMBER AS teacher ON matching.PROFESSOR_MEMBER_ID = teacher.MEMBER_ID
		WHERE 1=1
		AND matching.YEAR = #{YEAR}
		<if test="PROFESSOR_MEMBER_ID != ''">
	    	AND matching.PROFESSOR_MEMBER_ID = #{PROFESSOR_MEMBER_ID}
	    </if>
	   	<if test="SUPPORT_GROUP != ''">
	    	AND matching.SUPPORT_GROUP = #{SUPPORT_GROUP}
	    </if>
	    <if test="LO_TYPE == 'TRUE'">
	    	AND student.ADDRESS_LOCAL IN 
		    <foreach collection="LO_LIST" item="bno" open="(" close=")" separator=",">
		    	#{bno}
		    </foreach>
	    </if>
	     <if test="SEARCH_TEXT != ''">
		     <if test="SEARCH_TYPE == 'ALL'">
		    	AND (
		    		NAME LIKE '%${SEARCH_TEXT}%' 
		    		OR  matching.MEMBER_ID LIKE '%${SEARCH_TEXT}%'
		    		OR  matching.SCHOOL_NAME LIKE '%${SEARCH_TEXT}%'
		    		OR  matching.PROFESSOR_MEMBER_ID LIKE '%${SEARCH_TEXT}%'
		    		OR  matching.PROFESSOR_MEMBER_NAME LIKE '%${SEARCH_TEXT}%'
		    		
		    		
		    		) 
		    </if>
		    <if test="SEARCH_TYPE != 'ALL'">
	    		 AND matching.${SEARCH_TYPE} LIKE '%${SEARCH_TEXT}%'
	    	</if>
	    </if>
		ORDER BY student.NAME , matching.UPDATE_TM
	</select>
	
	<select id="getListGroupByYear" resultType="hashMap" >
		SELECT /*AdminMatchingMapper*/ * FROM TBL_MATCHING GROUP BY YEAR ORDER BY YEAR DESC
	</select>
	<select id="getListGroupBySUPPORT_GROUP" resultType="hashMap" >
		SELECT /*AdminMatchingMapper*/ * FROM TBL_MATCHING GROUP BY SUPPORT_GROUP ORDER BY YEAR DESC
	</select>
	<select id="getListGroupByENROLLMENT_STATUS" resultType="hashMap" >
		SELECT /*AdminMatchingMapper*/ * FROM TBL_MATCHING GROUP BY ENROLLMENT_STATUS ORDER BY ENROLLMENT_STATUS DESC
	</select>	
	

	<select id="getView" resultType="egovframework.kaist.admin.matching.model.AdminMatchingVo" parameterType="String">
		SELECT /*AdminMatchingMapper*/ *,
		(SELECT NAME FROM TBL_MEMBER WHERE MEMBER_ID = TBL_MATCHING.MEMBER_ID) AS NAME FROM TBL_MATCHING where MEMBER_ID = #{value};
	</select>
	

	<insert id="setInsert"	parameterType="egovframework.kaist.admin.matching.model.AdminMatchingVo">
		INSERT INTO /*AdminMatchingMapper*/ TBL_MATCHING (
			MEMBER_ID, 
			PROFESSOR_MEMBER_ID, 
			SUPPORT_GROUP, 
			YEAR, 
			SCHOOL_NAME, 
			SCHOOL_YEAR, 
			SCHOOL_GROUP, 
						 
			ENROLLMENT_STATUS, 
			FILES, 
			MEMO, 
			CREATE_TM, 
			UPDATE_TM 

		) VALUES (
			#{MEMBER_ID}, 
			#{PROFESSOR_MEMBER_ID}, 
			#{SUPPORT_GROUP}, 
			#{YEAR}, 

			#{SCHOOL_NAME}, 
			#{SCHOOL_YEAR}, 
			#{SCHOOL_GROUP}, 
			 
			#{ENROLLMENT_STATUS}, 
			#{FILES}, 
			#{MEMO}, 
			now(), 
			now() 
		) 
	</insert>

	<update id="setUpdate"	parameterType="egovframework.kaist.admin.matching.model.AdminMatchingVo">
		UPDATE /*AdminMatchingMapper*/ TBL_MATCHING SET 
			PROFESSOR_MEMBER_ID= #{PROFESSOR_MEMBER_ID},
			<if test="FILES != ''"> 
			FILES= #{FILES}, 
			</if>
			UPDATE_TM= now() 
		WHERE
			MEMBER_ID = #{MEMBER_ID} 
			AND YEAR= #{YEAR}
	</update>
	
	
	<delete id="setDelete"	parameterType="egovframework.kaist.admin.matching.model.AdminMatchingVo">
		DELETE FROM /*AdminMatchingMapper*/
			TBL_MATCHING
		WHERE MEMBER_ID =  #{MEMBER_ID}
		<if test="PROFESSOR_MEMBER_ID != ''">
		AND  PROFESSOR_MEMBER_ID = #{PROFESSOR_MEMBER_ID}
		</if>
		AND YEAR = #{YEAR}
	</delete>
	<update id="setUpdateTypeToText"	parameterType="egovframework.kaist.admin.matching.model.AdminMatchingVo">
		UPDATE /*AdminMemberMapper*/ TBL_MATCHING SET 
			${SEARCH_TYPE} = #{SEARCH_TEXT},
			UPDATE_TM = now()
		WHERE
			MEMBER_ID = #{MEMBER_ID} 
	</update>
	<select id="getMatchingNotMemberList" resultType="hashMap" parameterType="egovframework.kaist.admin.matching.model.AdminMatchingVo">
		SELECT /*AdminMemberMapper*/ A.* FROM (SELECT * FROM TBL_MEMBER WHERE TYPE = 1) AS A
		LEFT JOIN
		  (SELECT MEMBER_ID FROM TBL_MATCHING <if test="YEAR != ''">WHERE YEAR =#{YEAR}</if>) AS B ON A.MEMBER_ID = B.MEMBER_ID
		WHERE B.MEMBER_ID IS NULL AND ADDRESS_LOCAL = #{LOCATION}  AND EXP_DATA LIKE '%${EXP_DATA}%' ORDER BY A.NAME
	</select>
	
	<select id="getOneList" resultType="hashMap" parameterType="egovframework.kaist.admin.matching.model.AdminMatchingVo">
		SELECT * FROM TBL_MATCHING
		WHERE MEMBER_ID = #{MEMBER_ID}
		AND PROFESSOR_MEMBER_ID = #{PROFESSOR_MEMBER_ID}
	</select>
	
	<select id="getViewCheck" resultType="egovframework.kaist.admin.matching.model.AdminMatchingVo" parameterType="egovframework.kaist.admin.matching.model.AdminMatchingVo">
		SELECT /*AdminMatchingMapper*/ *,
		(SELECT NAME FROM TBL_MEMBER WHERE MEMBER_ID = TBL_MATCHING.MEMBER_ID) AS NAME FROM TBL_MATCHING where MEMBER_ID = #{MEMBER_ID} and YEAR = #{YEAR}
	</select>
    
</mapper>